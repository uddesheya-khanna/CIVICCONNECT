<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civic Connect - Feed</title>
    
    <!-- README & Demo Instructions -->
    <!--
    CIVIC CONNECT - FEED Demo Application
    ====================================
    
    HOW TO RUN:
    1. Save this file as "index.html"
    2. Open in any modern web browser (Chrome, Firefox, Safari, Edge)
    3. No build step or server required - runs completely offline
    
    DEMO ACCOUNTS (use "Demo Login" dropdown for quick access):
    - Citizen 1: +911234567890 / OTP: 000000
    - Citizen 2: +919876543210 / OTP: 000000  
    - Officer: officer1@municipal.gov.in / Password: OfficerPass1!
    - Staff: staff1@municipal.gov.in / Password: StaffPass1!
    
    DEMO SCRIPT:
    1. Open index.html in browser
    2. Click "Demo Login" → select "Officer Login" → Login
    3. Open new tab/window with same file
    4. In new tab: "Demo Login" → "Citizen 1" → Login
    5. In citizen tab: Click "+" button → Create new complaint
    6. Switch to officer tab → See new complaint → Click "Triage" → "Assign" 
    7. Add update with remarks → Switch to citizen tab → See progress updated
    8. Officer: Mark as resolved → Citizen sees 100% progress + notification
    
    FEATURES IMPLEMENTED:
    ✓ Clean login (no operational metrics on login screen)
    ✓ Instagram-style feed with progress bars
    ✓ Complaint composer with media upload
    ✓ Real-time cross-tab updates (BroadcastChannel)
    ✓ Authority interface with queue management
    ✓ Progress mapping (0% → 100% based on status)
    ✓ Offline support with sync queue
    ✓ Notifications system
    ✓ Accessibility features (ARIA, keyboard nav)
    ✓ Responsive design
    ✓ Hindi/English toggle
    
    EXTERNAL DEPENDENCIES:
    - Font Awesome (icons) - CDN with offline fallback
    - Google Fonts (optional) - graceful fallback to system fonts
    
    API INTEGRATION NOTES:
    - All server calls are in mockServer module
    - Search for "// Replace with real API" comments
    - See integration examples at bottom of JS code
    -->
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" onerror="this.remove()">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" onerror="this.remove()">
    
    <style>
        /* CSS Variables for theming */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --neutral-50: #f8fafc;
            --neutral-100: #f1f5f9;
            --neutral-200: #e2e8f0;
            --neutral-300: #cbd5e1;
            --neutral-400: #94a3b8;
            --neutral-500: #64748b;
            --neutral-600: #475569;
            --neutral-700: #334155;
            --neutral-800: #1e293b;
            --neutral-900: #0f172a;
            
            --spacing-1: 0.25rem;
            --spacing-2: 0.5rem;
            --spacing-3: 0.75rem;
            --spacing-4: 1rem;
            --spacing-5: 1.25rem;
            --spacing-6: 1.5rem;
            --spacing-8: 2rem;
            --spacing-12: 3rem;
            
            --border-radius: 0.5rem;
            --border-radius-lg: 0.75rem;
            --border-radius-xl: 1rem;
            
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        
        /* Reset and Base Styles */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--neutral-700);
            background-color: var(--neutral-50);
        }
        
        /* Utility Classes */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .hidden {
            display: none !important;
        }
        
        .flex {
            display: flex;
        }
        
        .flex-col {
            flex-direction: column;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .gap-2 {
            gap: var(--spacing-2);
        }
        
        .gap-4 {
            gap: var(--spacing-4);
        }
        
        .p-4 {
            padding: var(--spacing-4);
        }
        
        .p-6 {
            padding: var(--spacing-6);
        }
        
        .mb-4 {
            margin-bottom: var(--spacing-4);
        }
        
        .mt-4 {
            margin-top: var(--spacing-4);
        }
        
        .text-center {
            text-align: center;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        .text-lg {
            font-size: 1.125rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
        }
        
        .text-2xl {
            font-size: 1.5rem;
        }
        
        .rounded {
            border-radius: var(--border-radius);
        }
        
        .rounded-lg {
            border-radius: var(--border-radius-lg);
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .shadow {
            box-shadow: var(--shadow);
        }
        
        .shadow-lg {
            box-shadow: var(--shadow-lg);
        }
        
        /* Component Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-2);
            padding: var(--spacing-3) var(--spacing-6);
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--border-radius);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            min-height: 44px; /* Touch target size */
        }
        
        .btn:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--neutral-100);
            color: var(--neutral-700);
            border-color: var(--neutral-200);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--neutral-200);
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: white;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .input {
            width: 100%;
            padding: var(--spacing-3);
            border: 1px solid var(--neutral-300);
            border-radius: var(--border-radius);
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
            min-height: 44px; /* Touch target size */
        }
        
        .input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgb(79 70 229 / 0.1);
        }
        
        .input.error {
            border-color: var(--danger);
        }
        
        .form-group {
            margin-bottom: var(--spacing-4);
        }
        
        .form-label {
            display: block;
            margin-bottom: var(--spacing-2);
            font-weight: 500;
            color: var(--neutral-700);
        }
        
        .error-message {
            margin-top: var(--spacing-1);
            font-size: 0.75rem;
            color: var(--danger);
        }
        
        .card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        /* Layout */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 var(--spacing-4);
        }
        
        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            padding: var(--spacing-4);
        }
        
        .login-card {
            width: 100%;
            max-width: 400px;
            background: white;
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-8);
            box-shadow: var(--shadow-lg);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-8);
        }
        
        .login-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: var(--spacing-2);
        }
        
        .login-subtitle {
            color: var(--neutral-500);
        }
        
        /* Feed Layout */
        .app-header {
            background: white;
            border-bottom: 1px solid var(--neutral-200);
            padding: var(--spacing-4) 0;
            position: sticky;
            top: 0;
            z-index: 40;
        }
        
        .app-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .app-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            text-decoration: none;
        }
        
        .nav-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-4);
        }
        
        .feed-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--spacing-6);
            padding: var(--spacing-6) 0;
            min-height: calc(100vh - 80px);
        }
        
        @media (min-width: 768px) {
            .feed-container {
                grid-template-columns: 1fr 300px;
            }
        }
        
        .feed-main {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .feed-sidebar {
            position: sticky;
            top: 100px;
            height: fit-content;
        }
        
        /* Post Card */
        .post-card {
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            margin-bottom: var(--spacing-6);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .post-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }
        
        .post-header {
            padding: var(--spacing-4);
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
        }
        
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .post-meta {
            flex: 1;
        }
        
        .post-author {
            font-weight: 600;
            color: var(--neutral-900);
        }
        
        .post-time {
            font-size: 0.75rem;
            color: var(--neutral-500);
        }
        
        .post-ward-badge {
            background: var(--primary);
            color: white;
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .post-media {
            position: relative;
            aspect-ratio: 16/9;
            background: var(--neutral-100);
            overflow: hidden;
        }
        
        .post-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .post-content {
            padding: var(--spacing-4);
        }
        
        .post-category {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-1);
            background: var(--neutral-100);
            color: var(--neutral-700);
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: var(--spacing-3);
        }
        
        .post-description {
            color: var(--neutral-700);
            margin-bottom: var(--spacing-4);
        }
        
        .post-location {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            color: var(--neutral-500);
            font-size: 0.875rem;
            margin-bottom: var(--spacing-4);
        }
        
        .post-location a {
            color: var(--primary);
            text-decoration: none;
        }
        
        .post-location a:hover {
            text-decoration: underline;
        }
        
        /* Progress Bar */
        .progress-container {
            margin-bottom: var(--spacing-4);
        }
        
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-2);
        }
        
        .progress-percent {
            font-weight: 600;
            color: var(--neutral-900);
        }
        
        .status-chip {
            padding: var(--spacing-1) var(--spacing-2);
            border-radius: var(--border-radius);
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .status-submitted {
            background: var(--neutral-100);
            color: var(--neutral-700);
        }
        
        .status-triaged {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status-assigned {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-in-progress {
            background: #ddd6fe;
            color: #7c3aed;
        }
        
        .status-awaiting-verification {
            background: #fed7aa;
            color: #ea580c;
        }
        
        .status-resolved {
            background: #dcfce7;
            color: #166534;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--neutral-200);
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--success));
            border-radius: 4px;
            transition: width 0.3s ease;
            min-width: 2px;
        }
        
        /* Post Actions */
        .post-actions {
            padding: var(--spacing-4);
            padding-top: 0;
            display: flex;
            align-items: center;
            gap: var(--spacing-6);
        }
        
        .action-btn {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            background: none;
            border: none;
            color: var(--neutral-500);
            cursor: pointer;
            font-size: 0.875rem;
            padding: var(--spacing-2);
            border-radius: var(--border-radius);
            transition: color 0.2s, background-color 0.2s;
            min-height: 36px;
        }
        
        .action-btn:hover {
            color: var(--neutral-700);
            background: var(--neutral-100);
        }
        
        .action-btn:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        .action-btn.active {
            color: var(--primary);
        }
        
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: var(--spacing-6);
            right: var(--spacing-6);
            width: 56px;
            height: 56px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            font-size: 1.25rem;
            transition: transform 0.2s, box-shadow 0.2s;
            z-index: 50;
        }
        
        .fab:hover {
            transform: scale(1.1);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }
        
        .fab:focus {
            outline: 2px solid var(--primary);
            outline-offset: 4px;
        }
        
        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: var(--spacing-4);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal {
            background: white;
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal-overlay.active .modal {
            transform: scale(1) translateY(0);
        }
        
        .modal-header {
            padding: var(--spacing-6);
            border-bottom: 1px solid var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--neutral-900);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--neutral-500);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--border-radius);
            transition: color 0.2s, background-color 0.2s;
        }
        
        .modal-close:hover {
            color: var(--neutral-700);
            background: var(--neutral-100);
        }
        
        .modal-body {
            padding: var(--spacing-6);
        }
        
        /* Notifications */
        .notification-bell {
            position: relative;
            background: none;
            border: none;
            color: var(--neutral-500);
            cursor: pointer;
            padding: var(--spacing-2);
            border-radius: var(--border-radius);
            transition: color 0.2s, background-color 0.2s;
        }
        
        .notification-bell:hover {
            color: var(--neutral-700);
            background: var(--neutral-100);
        }
        
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translate(25%, -25%);
        }
        
        .notification-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 320px;
            background: white;
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--neutral-200);
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
        }
        
        .notification-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .notification-item {
            padding: var(--spacing-4);
            border-bottom: 1px solid var(--neutral-100);
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .notification-item.unread {
            background: var(--neutral-50);
        }
        
        /* Toast */
        .toast {
            position: fixed;
            bottom: var(--spacing-6);
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--neutral-900);
            color: white;
            padding: var(--spacing-4) var(--spacing-6);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transition: transform 0.3s;
        }
        
        .toast.show {
            transform: translateX(-50%) translateY(0);
        }
        
        .toast.success {
            background: var(--success);
        }
        
        .toast.error {
            background: var(--danger);
        }
        
        /* Skeleton Loading */
        .skeleton {
            background: linear-gradient(90deg, var(--neutral-200) 25%, var(--neutral-100) 50%, var(--neutral-200) 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        
        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .skeleton-post {
            background: white;
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-6);
        }
        
        .skeleton-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-3);
            margin-bottom: var(--spacing-4);
        }
        
        .skeleton-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }
        
        .skeleton-text {
            height: 16px;
            border-radius: var(--border-radius);
        }
        
        .skeleton-text.w-24 {
            width: 6rem;
        }
        
        .skeleton-text.w-16 {
            width: 4rem;
        }
        
        .skeleton-text.w-32 {
            width: 8rem;
        }
        
        .skeleton-media {
            width: 100%;
            height: 200px;
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-4);
        }
        
        /* Authority Interface */
        .authority-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: var(--spacing-4);
            margin-bottom: var(--spacing-6);
            border-radius: var(--border-radius-lg);
        }
        
        .authority-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-4);
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: var(--spacing-4);
            border-radius: var(--border-radius);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: var(--spacing-1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }
        
        .authority-actions {
            display: flex;
            align-items: center;
            gap: var(--spacing-2);
            margin-bottom: var(--spacing-4);
        }
        
        .authority-btn {
            background: var(--success);
            color: white;
            border: none;
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .authority-btn:hover {
            background: #059669;
        }
        
        .authority-btn.secondary {
            background: var(--warning);
        }
        
        .authority-btn.danger {
            background: var(--danger);
        }
        
        /* Offline Banner */
        .offline-banner {
            background: var(--warning);
            color: white;
            padding: var(--spacing-2) 0;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        /* Media Upload */
        .media-upload {
            border: 2px dashed var(--neutral-300);
            border-radius: var(--border-radius);
            padding: var(--spacing-6);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, background-color 0.2s;
        }
        
        .media-upload:hover {
            border-color: var(--primary);
            background-color: var(--neutral-50);
        }
        
        .media-upload.dragover {
            border-color: var(--primary);
            background-color: #eef2ff;
        }
        
        .media-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: var(--spacing-2);
            margin-top: var(--spacing-4);
        }
        
        .media-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .media-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .media-remove {
            position: absolute;
            top: var(--spacing-1);
            right: var(--spacing-1);
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }
        
        /* Language Toggle */
        .lang-toggle {
            background: none;
            border: 1px solid var(--neutral-300);
            color: var(--neutral-700);
            padding: var(--spacing-2) var(--spacing-3);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.875rem;
            transition: border-color 0.2s, color 0.2s;
        }
        
        .lang-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 0 var(--spacing-3);
            }
            
            .feed-container {
                grid-template-columns: 1fr;
                padding: var(--spacing-4) 0;
            }
            
            .feed-sidebar {
                display: none;
            }
            
            .authority-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .modal {
                margin: var(--spacing-4);
                max-width: none;
            }
            
            .notification-dropdown {
                width: calc(100vw - var(--spacing-8));
                right: var(--spacing-4);
            }
        }
        
        /* Focus Styles for Accessibility */
        *:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        
        /* Live Region for Screen Readers */
        .live-region {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <!-- Live region for screen reader announcements -->
    <div id="liveRegion" class="live-region" aria-live="polite" aria-atomic="true"></div>
    
    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner hidden">
        <i class="fas fa-wifi-slash"></i> You're offline. Changes will sync when connection is restored.
    </div>
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1 class="login-title">Civic Connect</h1>
                <p class="login-subtitle" data-en="Sign in to your account" data-hi="अपने खाते में साइन इन करें">Sign in to your account</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" data-en="Phone/Email" data-hi="फ़ोन/ईमेल">Phone/Email</label>
                    <input type="text" id="loginId" class="input" placeholder="+91 9876543210 or email@example.com" required>
                    <div class="error-message" id="loginIdError"></div>
                </div>
                
                <div class="form-group" id="passwordGroup" style="display: none;">
                    <label class="form-label" data-en="Password" data-hi="पासवर्ड">Password</label>
                    <input type="password" id="password" class="input" placeholder="Enter password">
                    <div class="error-message" id="passwordError"></div>
                </div>
                
                <div class="form-group" id="otpGroup" style="display: none;">
                    <label class="form-label" data-en="Enter OTP" data-hi="OTP दर्ज करें">Enter OTP</label>
                    <input type="text" id="otp" class="input" placeholder="000000" maxlength="6">
                    <div class="error-message" id="otpError"></div>
                    <p class="text-sm" style="margin-top: 8px; color: var(--neutral-500);">
                        Demo OTP: <strong>000000</strong>
                    </p>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 16px;" id="loginBtn">
                    <span data-en="Continue" data-hi="जारी रखें">Continue</span>
                </button>
                
                <div class="form-group">
                    <label class="form-label" data-en="Quick Demo Login" data-hi="त्वरित डेमो लॉगिन">Quick Demo Login</label>
                    <select id="demoLogin" class="input">
                        <option value="">Select demo account...</option>
                        <option value="citizen1">Citizen 1 (+911234567890)</option>
                        <option value="citizen2">Citizen 2 (+919876543210)</option>
                        <option value="officer">Officer Login (officer1@municipal.gov.in)</option>
                        <option value="staff">Staff Login (staff1@municipal.gov.in)</option>
                    </select>
                </div>
            </form>
            
            <div style="text-align: center; margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--neutral-200);">
                <button type="button" class="lang-toggle" id="langToggle">हिंदी</button>
            </div>
            
            <div style="text-align: center; margin-top: 16px; font-size: 0.875rem; color: var(--neutral-500);">
                <a href="#" style="color: var(--primary); text-decoration: none; margin-right: 16px;" data-en="Sign Up" data-hi="साइन अप करें">Sign Up</a>
                <a href="#" style="color: var(--primary); text-decoration: none;" data-en="Forgot Password?" data-hi="पासवर्ड भूल गए?">Forgot Password?</a>
            </div>
        </div>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="container">
                <nav class="app-nav">
                    <a href="#" class="app-logo">Civic Connect</a>
                    <div class="nav-actions">
                        <button class="lang-toggle" id="langToggleApp">EN</button>
                        <div style="position: relative;">
                            <button class="notification-bell" id="notificationBtn">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge hidden" id="notificationBadge">0</span>
                            </button>
                            <div class="notification-dropdown" id="notificationDropdown">
                                <div style="padding: 16px; border-bottom: 1px solid var(--neutral-200); font-weight: 600;">
                                    <span data-en="Notifications" data-hi="सूचनाएं">Notifications</span>
                                </div>
                                <div id="notificationList">
                                    <div class="notification-item" style="text-align: center; color: var(--neutral-500);">
                                        <span data-en="No notifications" data-hi="कोई सूचना नहीं">No notifications</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div class="post-avatar" id="userAvatar">U</div>
                            <div>
                                <div style="font-weight: 600; color: var(--neutral-900);" id="userName">User</div>
                                <div style="font-size: 0.75rem; color: var(--neutral-500);" id="userRole">Citizen</div>
                            </div>
                            <button class="btn btn-secondary" id="logoutBtn" style="font-size: 0.75rem; padding: 4px 8px;">
                                <i class="fas fa-sign-out-alt"></i>
                            </button>
                        </div>
                    </div>
                </nav>
            </div>
        </header>
        
        <!-- Authority Header (for officers/staff) -->
        <div id="authorityHeader" class="container hidden">
            <div class="authority-header">
                <div class="authority-stats" id="authorityStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalComplaints">0</div>
                        <div class="stat-label" data-en="Total Complaints" data-hi="कुल शिकायतें">Total Complaints</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="pendingComplaints">0</div>
                        <div class="stat-label" data-en="Pending" data-hi="लंबित">Pending</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="resolvedComplaints">0</div>
                        <div class="stat-label" data-en="Resolved" data-hi="हल किया गया">Resolved</div>
                    </div>
                </div>
                
                <div style="margin-top: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                    <select id="wardFilter" class="input" style="width: auto; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;">
                        <option value="">All Wards</option>
                    </select>
                    <select id="statusFilter" class="input" style="width: auto; background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;">
                        <option value="">All Status</option>
                        <option value="SUBMITTED">Untriaged</option>
                        <option value="ASSIGNED">Assigned to Me</option>
                        <option value="overdue">Overdue</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Feed Container -->
        <div class="container">
            <div class="feed-container">
                <main class="feed-main">
                    <!-- Loading Skeleton -->
                    <div id="feedSkeleton">
                        <div class="skeleton-post">
                            <div class="skeleton-header">
                                <div class="skeleton skeleton-avatar"></div>
                                <div style="flex: 1;">
                                    <div class="skeleton skeleton-text w-24" style="margin-bottom: 4px;"></div>
                                    <div class="skeleton skeleton-text w-16"></div>
                                </div>
                                <div class="skeleton skeleton-text w-16"></div>
                            </div>
                            <div class="skeleton skeleton-media"></div>
                            <div class="skeleton skeleton-text w-32" style="margin-bottom: 8px;"></div>
                            <div class="skeleton skeleton-text" style="margin-bottom: 8px;"></div>
                            <div class="skeleton skeleton-text w-24"></div>
                        </div>
                        <div class="skeleton-post">
                            <div class="skeleton-header">
                                <div class="skeleton skeleton-avatar"></div>
                                <div style="flex: 1;">
                                    <div class="skeleton skeleton-text w-24" style="margin-bottom: 4px;"></div>
                                    <div class="skeleton skeleton-text w-16"></div>
                                </div>
                                <div class="skeleton skeleton-text w-16"></div>
                            </div>
                            <div class="skeleton skeleton-media"></div>
                            <div class="skeleton skeleton-text w-32" style="margin-bottom: 8px;"></div>
                            <div class="skeleton skeleton-text" style="margin-bottom: 8px;"></div>
                            <div class="skeleton skeleton-text w-24"></div>
                        </div>
                    </div>
                    
                    <!-- Feed Posts -->
                    <div id="feedPosts"></div>
                    
                    <!-- Load More Button -->
                    <div style="text-align: center; margin: 32px 0;">
                        <button class="btn btn-secondary" id="loadMoreBtn" style="display: none;">
                            <span data-en="Load More" data-hi="और लोड करें">Load More</span>
                        </button>
                    </div>
                </main>
                
                <!-- Sidebar -->
                <aside class="feed-sidebar">
                    <div class="card p-6">
                        <h3 style="margin-bottom: 16px; font-weight: 600;" data-en="Quick Stats" data-hi="त्वरित आंकड़े">Quick Stats</h3>
                        <div style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="display: flex; justify-content: space-between;">
                                <span data-en="My Posts" data-hi="मेरी पोस्ट">My Posts</span>
                                <span id="myPostsCount">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between;">
                                <span data-en="Resolved" data-hi="हल किया गया">Resolved</span>
                                <span id="myResolvedCount">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card p-6" style="margin-top: 16px;">
                        <h3 style="margin-bottom: 16px; font-weight: 600;" data-en="Categories" data-hi="श्रेणियां">Categories</h3>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-secondary" style="justify-content: flex-start;" data-category="ROAD">
                                <i class="fas fa-road"></i>
                                <span data-en="Road" data-hi="सड़क">Road</span>
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start;" data-category="GARBAGE">
                                <i class="fas fa-trash"></i>
                                <span data-en="Garbage" data-hi="कचरा">Garbage</span>
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start;" data-category="WATER">
                                <i class="fas fa-tint"></i>
                                <span data-en="Water" data-hi="पानी">Water</span>
                            </button>
                            <button class="btn btn-secondary" style="justify-content: flex-start;" data-category="ELECTRICITY">
                                <i class="fas fa-bolt"></i>
                                <span data-en="Electricity" data-hi="बिजली">Electricity</span>
                            </button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
        
        <!-- Floating Action Button -->
        <button class="fab" id="composerFab" title="Create new complaint">
            <i class="fas fa-plus"></i>
        </button>
    </div>
    
    <!-- Complaint Composer Modal -->
    <div class="modal-overlay" id="composerModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" data-en="New Complaint" data-hi="नई शिकायत">New Complaint</h2>
                <button class="modal-close" id="composerClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="complaintForm">
                    <div class="form-group">
                        <label class="form-label" data-en="Category*" data-hi="श्रेणी*">Category*</label>
                        <select id="complaintCategory" class="input" required>
                            <option value="">Select category...</option>
                            <option value="ROAD">Road</option>
                            <option value="GARBAGE">Garbage</option>
                            <option value="WATER">Water</option>
                            <option value="ELECTRICITY">Electricity</option>
                            <option value="OTHER">Other</option>
                        </select>
                        <div class="error-message" id="categoryError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-en="Severity" data-hi="गंभीरता">Severity</label>
                        <select id="complaintSeverity" class="input">
                            <option value="NORMAL">Normal</option>
                            <option value="URGENT">Urgent</option>
                            <option value="CRITICAL">Critical</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-en="Description*" data-hi="विवरण*">Description*</label>
                        <textarea id="complaintDescription" class="input" rows="4" placeholder="Describe the issue in detail..." minlength="10" required></textarea>
                        <div class="error-message" id="descriptionError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-en="Photos/Videos" data-hi="फ़ोटो/वीडियो">Photos/Videos</label>
                        <div class="media-upload" id="mediaUpload">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 2rem; color: var(--neutral-400); margin-bottom: 8px;"></i>
                            <p style="color: var(--neutral-500); margin-bottom: 4px;">
                                <span data-en="Click or drag files to upload" data-hi="अपलोड करने के लिए क्लिक करें या फ़ाइलें खींचें">Click or drag files to upload</span>
                            </p>
                            <p style="font-size: 0.75rem; color: var(--neutral-400);">
                                <span data-en="Images and videos up to 5MB" data-hi="5MB तक की इमेज और वीडियो">Images and videos up to 5MB</span>
                            </p>
                            <input type="file" id="mediaInput" multiple accept="image/*,video/*" style="display: none;">
                        </div>
                        <div class="media-preview" id="mediaPreview"></div>
                        <div class="error-message" id="mediaError"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" data-en="Location" data-hi="स्थान">Location</label>
                        <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <button type="button" class="btn btn-secondary" id="detectLocationBtn">
                                <i class="fas fa-map-marker-alt"></i>
                                <span data-en="Detect Location" data-hi="स्थान का पता लगाएं">Detect Location</span>
                            </button>
                            <span id="locationStatus" style="color: var(--neutral-500); font-size: 0.875rem; line-height: 36px;"></span>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <input type="number" id="complaintLat" class="input" placeholder="Latitude" step="any">
                            <input type="number" id="complaintLng" class="input" placeholder="Longitude" step="any">
                        </div>
                        <div class="error-message" id="locationError"></div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; margin-top: 24px;">
                        <button type="button" class="btn btn-secondary" id="cancelComplaint" style="flex: 1;">
                            <span data-en="Cancel" data-hi="रद्द करें">Cancel</span>
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitComplaint" style="flex: 2;">
                            <span data-en="Submit Complaint" data-hi="शिकायत दर्ज करें">Submit Complaint</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Complaint Detail Modal -->
    <div class="modal-overlay" id="detailModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" data-en="Complaint Details" data-hi="शिकायत विवरण">Complaint Details</h2>
                <button class="modal-close" id="detailClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="detailContent">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <script>
        // =============================================================================
        // CIVIC CONNECT - FEED Application
        // =============================================================================
        
        // Application State
        let currentUser = null;
        let currentLanguage = 'en';
        let feedPosts = [];
        let feedOffset = 0;
        const feedLimit = 10;
        let isLoading = false;
        
        // Mock Server Implementation
        // Replace all these functions with real API calls in production
        const mockServer = {
            // Authentication
            async login(credentials) {
                // Replace with real API: POST /auth/login
                await delay(500); // Simulate network delay
                
                const { loginId, password, otp } = credentials;
                
                // Demo accounts
                const users = JSON.parse(localStorage.getItem('civic_users') || '{}');
                
                if (loginId.includes('@')) {
                    // Email login (authority)
                    const user = Object.values(users).find(u => u.email === loginId && u.password === password);
                    if (user) {
                        return { success: true, user, token: 'mock-jwt-token' };
                    }
                } else {
                    // Phone login (citizen)
                    if (otp === '000000') {
                        const user = Object.values(users).find(u => u.phone === loginId);
                        if (user) {
                            return { success: true, user, token: 'mock-jwt-token' };
                        }
                    }
                }
                
                return { success: false, error: 'Invalid credentials' };
            },
            
            async requestOTP(phone) {
                // Replace with real API: POST /auth/otp/request
                await delay(300);
                return { success: true, message: 'OTP sent successfully' };
            },
            
            // Complaints
            async getComplaints(filters = {}) {
                // Replace with real API: GET /complaints?ward=X&status=Y&offset=Z&limit=N
                await delay(800);
                
                const complaints = JSON.parse(localStorage.getItem('civic_complaints') || '[]');
                const users = JSON.parse(localStorage.getItem('civic_users') || '{}');
                
                let filtered = [...complaints];
                
                // Apply filters
                if (filters.ward) {
                    filtered = filtered.filter(c => c.wardId === filters.ward);
                }
                if (filters.status) {
                    filtered = filtered.filter(c => c.status === filters.status);
                }
                if (filters.userId) {
                    filtered = filtered.filter(c => c.userId === filters.userId);
                }
                if (filters.assignedTo) {
                    filtered = filtered.filter(c => c.assignedTo === filters.assignedTo);
                }
                
                // Sort by created date (newest first)
                filtered.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                // Apply pagination
                const offset = filters.offset || 0;
                const limit = filters.limit || 10;
                const paginated = filtered.slice(offset, offset + limit);
                
                // Enhance with user data
                const enhanced = paginated.map(complaint => ({
                    ...complaint,
                    user: users[complaint.userId] || { name: 'Unknown User' }
                }));
                
                return {
                    complaints: enhanced,
                    total: filtered.length,
                    hasMore: offset + limit < filtered.length
                };
            },
            
            async createComplaint(complaint) {
                // Replace with real API: POST /complaints
                await delay(600);
                
                const complaints = JSON.parse(localStorage.getItem('civic_complaints') || '[]');
                const newComplaint = {
                    ...complaint,
                    id: generateId(),
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    status: 'SUBMITTED',
                    progressPercent: 0,
                    votesCount: 0,
                    commentsCount: 0
                };
                
                complaints.unshift(newComplaint);
                localStorage.setItem('civic_complaints', JSON.stringify(complaints));
                
                // Broadcast to other tabs
                broadcastUpdate('complaint_created', newComplaint);
                
                return { success: true, complaint: newComplaint };
            },
            
            async updateComplaint(id, updates) {
                // Replace with real API: PUT /complaints/:id
                await delay(400);
                
                const complaints = JSON.parse(localStorage.getItem('civic_complaints') || '[]');
                const index = complaints.findIndex(c => c.id === id);
                
                if (index === -1) {
                    return { success: false, error: 'Complaint not found' };
                }
                
                const oldComplaint = complaints[index];
                const updatedComplaint = {
                    ...oldComplaint,
                    ...updates,
                    updatedAt: new Date().toISOString()
                };
                
                // Update progress based on status
                updatedComplaint.progressPercent = getProgressPercent(updates.status || oldComplaint.status);
                
                complaints[index] = updatedComplaint;
                localStorage.setItem('civic_complaints', JSON.stringify(complaints));
                
                // Add to updates timeline
                if (updates.status || updates.remarks) {
                    await this.addComplaintUpdate(id, {
                        userId: currentUser.id,
                        status: updates.status,
                        remarks: updates.remarks,
                        media: updates.media
                    });
                }
                
                // Create notification for complaint owner
                if (updatedComplaint.userId !== currentUser.id) {
                    await this.addNotification(updatedComplaint.userId, {
                        type: 'complaint_updated',
                        title: 'Complaint Updated',
                        message: `Your complaint has been updated to ${updates.status || oldComplaint.status}`,
                        complaintId: id
                    });
                }
                
                // Broadcast to other tabs
                broadcastUpdate('complaint_updated', updatedComplaint);
                
                return { success: true, complaint: updatedComplaint };
            },
            
            // Complaint Updates (Timeline)
            async addComplaintUpdate(complaintId, update) {
                // Replace with real API: POST /complaints/:id/updates
                await delay(200);
                
                const updates = JSON.parse(localStorage.getItem('civic_complaint_updates') || '[]');
                const newUpdate = {
                    ...update,
                    id: generateId(),
                    complaintId,
                    createdAt: new Date().toISOString(),
                    progressPercent: getProgressPercent(update.status)
                };
                
                updates.push(newUpdate);
                localStorage.setItem('civic_complaint_updates', JSON.stringify(updates));
                
                return { success: true, update: newUpdate };
            },
            
            async getComplaintUpdates(complaintId) {
                // Replace with real API: GET /complaints/:id/updates
                await delay(300);
                
                const updates = JSON.parse(localStorage.getItem('civic_complaint_updates') || '[]');
                const users = JSON.parse(localStorage.getItem('civic_users') || '{}');
                
                const filtered = updates
                    .filter(u => u.complaintId === complaintId)
                    .map(update => ({
                        ...update,
                        user: users[update.userId] || { name: 'Unknown User' }
                    }))
                    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                
                return { updates: filtered };
            },
            
            // Comments
            async addComment(complaintId, comment) {
                // Replace with real API: POST /complaints/:id/comments
                await delay(300);
                
                const comments = JSON.parse(localStorage.getItem('civic_comments') || '[]');
                const newComment = {
                    ...comment,
                    id: generateId(),
                    complaintId,
                    userId: currentUser.id,
                    createdAt: new Date().toISOString()
                };
                
                comments.push(newComment);
                localStorage.setItem('civic_comments', JSON.stringify(comments));
                
                // Update comment count
                const complaints = JSON.parse(localStorage.getItem('civic_complaints') || '[]');
                const complaintIndex = complaints.findIndex(c => c.id === complaintId);
                if (complaintIndex !== -1) {
                    complaints[complaintIndex].commentsCount = (complaints[complaintIndex].commentsCount || 0) + 1;
                    localStorage.setItem('civic_complaints', JSON.stringify(complaints));
                }
                
                // Broadcast to other tabs
                broadcastUpdate('comment_added', newComment);
                
                return { success: true, comment: newComment };
            },
            
            async getComments(complaintId) {
                // Replace with real API: GET /complaints/:id/comments
                await delay(200);
                
                const comments = JSON.parse(localStorage.getItem('civic_comments') || '[]');
                const users = JSON.parse(localStorage.getItem('civic_users') || '{}');
                
                const filtered = comments
                    .filter(c => c.complaintId === complaintId)
                    .map(comment => ({
                        ...comment,
                        user: users[comment.userId] || { name: 'Unknown User' }
                    }))
                    .sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                
                return { comments: filtered };
            },
            
            // Votes
            async toggleVote(complaintId) {
                // Replace with real API: POST /complaints/:id/vote
                await delay(200);
                
                const votes = JSON.parse(localStorage.getItem('civic_votes') || '[]');
                const existingVote = votes.find(v => v.complaintId === complaintId && v.userId === currentUser.id);
                
                if (existingVote) {
                    // Remove vote
                    const index = votes.indexOf(existingVote);
                    votes.splice(index, 1);
                } else {
                    // Add vote
                    votes.push({
                        id: generateId(),
                        complaintId,
                        userId: currentUser.id,
                        createdAt: new Date().toISOString()
                    });
                }
                
                localStorage.setItem('civic_votes', JSON.stringify(votes));
                
                // Update vote count
                const complaints = JSON.parse(localStorage.getItem('civic_complaints') || '[]');
                const complaintIndex = complaints.findIndex(c => c.id === complaintId);
                if (complaintIndex !== -1) {
                    const voteCount = votes.filter(v => v.complaintId === complaintId).length;
                    complaints[complaintIndex].votesCount = voteCount;
                    localStorage.setItem('civic_complaints', JSON.stringify(complaints));
                }
                
                // Broadcast to other tabs
                broadcastUpdate('vote_toggled', { complaintId, userId: currentUser.id });
                
                return { success: true, voted: !existingVote };
            },
            
            async getUserVotes(userId) {
                // Replace with real API: GET /users/:id/votes
                const votes = JSON.parse(localStorage.getItem('civic_votes') || '[]');
                return votes.filter(v => v.userId === userId);
            },
            
            // Notifications
            async addNotification(userId, notification) {
                // Replace with real API: POST /notifications
                const notifications = JSON.parse(localStorage.getItem('civic_notifications') || '[]');
                const newNotification = {
                    ...notification,
                    id: generateId(),
                    userId,
                    read: false,
                    createdAt: new Date().toISOString()
                };
                
                notifications.unshift(newNotification);
                localStorage.setItem('civic_notifications', JSON.stringify(notifications));
                
                // Broadcast to other tabs
                broadcastUpdate('notification_added', newNotification);
                
                // Show browser notification if permission granted
                if (Notification.permission === 'granted') {
                    new Notification(notification.title, {
                        body: notification.message,
                        icon: '/favicon.ico'
                    });
                }
                
                return { success: true, notification: newNotification };
            },
            
            async getNotifications(userId) {
                // Replace with real API: GET /notifications
                const notifications = JSON.parse(localStorage.getItem('civic_notifications') || '[]');
                return notifications
                    .filter(n => n.userId === userId)
                    .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            },
            
            async markNotificationRead(id) {
                // Replace with real API: PUT /notifications/:id
                const notifications = JSON.parse(localStorage.getItem('civic_notifications') || '[]');
                const index = notifications.findIndex(n => n.id === id);
                if (index !== -1) {
                    notifications[index].read = true;
                    localStorage.setItem('civic_notifications', JSON.stringify(notifications));
                }
                return { success: true };
            }
        };
        
        // Utility Functions
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        function generateId() {
            return 'id_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }
        
        function getProgressPercent(status) {
            const mapping = {
                'SUBMITTED': 0,
                'TRIAGED': 20,
                'ASSIGNED': 40,
                'IN_PROGRESS': 70,
                'AWAITING_VERIFICATION': 90,
                'RESOLVED': 100,
                'CLOSED': 100
            };
            return mapping[status] || 0;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const hours = diff / (1000 * 60 * 60);
            
            if (hours < 1) {
                return Math.floor(diff / (1000 * 60)) + 'm';
            } else if (hours < 24) {
                return Math.floor(hours) + 'h';
            } else {
                return Math.floor(hours / 24) + 'd';
            }
        }
        
        function getStatusClass(status) {
            const mapping = {
                'SUBMITTED': 'status-submitted',
                'TRIAGED': 'status-triaged',
                'ASSIGNED': 'status-assigned',
                'IN_PROGRESS': 'status-in-progress',
                'AWAITING_VERIFICATION': 'status-awaiting-verification',
                'RESOLVED': 'status-resolved',
                'CLOSED': 'status-resolved'
            };
            return mapping[status] || 'status-submitted';
        }
        
        function getStatusText(status) {
            const mapping = {
                'SUBMITTED': { en: 'Submitted', hi: 'प्रस्तुत' },
                'TRIAGED': { en: 'Triaged', hi: 'वर्गीकृत' },
                'ASSIGNED': { en: 'Assigned', hi: 'सौंपा गया' },
                'IN_PROGRESS': { en: 'In Progress', hi: 'प्रगति में' },
                'AWAITING_VERIFICATION': { en: 'Awaiting Verification', hi: 'सत्यापन की प्रतीक्षा' },
                'RESOLVED': { en: 'Resolved', hi: 'हल हो गया' },
                'CLOSED': { en: 'Closed', hi: 'बंद' }
            };
            return mapping[status]?.[currentLanguage] || status;
        }
        
        function getCategoryIcon(category) {
            const mapping = {
                'ROAD': 'fas fa-road',
                'GARBAGE': 'fas fa-trash',
                'WATER': 'fas fa-tint',
                'ELECTRICITY': 'fas fa-bolt',
                'OTHER': 'fas fa-exclamation-circle'
            };
            return mapping[category] || 'fas fa-exclamation-circle';
        }
        
        function announceToScreenReader(message) {
            const liveRegion = document.getElementById('liveRegion');
            liveRegion.textContent = message;
            setTimeout(() => liveRegion.textContent = '', 1000);
        }
        
        // Cross-tab Communication
        const broadcastChannel = new BroadcastChannel('civic_connect');
        
        function broadcastUpdate(type, data) {
            broadcastChannel.postMessage({ type, data, timestamp: Date.now() });
        }
        
        broadcastChannel.onmessage = (event) => {
            const { type, data } = event.data;
            
            switch (type) {
                case 'complaint_created':
                case 'complaint_updated':
                    // Refresh feed if we're on the same ward
                    if (shouldShowComplaint(data)) {
                        loadFeed(true);
                        updateStats();
                    }
                    break;
                case 'comment_added':
                case 'vote_toggled':
                    loadFeed(true);
                    break;
                case 'notification_added':
                    if (data.userId === currentUser?.id) {
                        loadNotifications();
                    }
                    break;
            }
        };
        
        function shouldShowComplaint(complaint) {
            if (!currentUser) return false;
            
            if (currentUser.role === 'CITIZEN') {
                return currentUser.wardIds.includes(complaint.wardId);
            } else {
                return currentUser.wardIds.includes(complaint.wardId) || !complaint.wardId;
            }
        }
        
        // Language Support
        const strings = {
            en: {
                'Sign in to your account': 'Sign in to your account',
                'Phone/Email': 'Phone/Email',
                'Password': 'Password',
                'Enter OTP': 'Enter OTP',
                'Continue': 'Continue',
                'Quick Demo Login': 'Quick Demo Login',
                'Sign Up': 'Sign Up',
                'Forgot Password?': 'Forgot Password?',
                'New Complaint': 'New Complaint',
                'Category*': 'Category*',
                'Severity': 'Severity',
                'Description*': 'Description*',
                'Photos/Videos': 'Photos/Videos',
                'Location': 'Location',
                'Detect Location': 'Detect Location',
                'Cancel': 'Cancel',
                'Submit Complaint': 'Submit Complaint',
                'Complaint Details': 'Complaint Details',
                'Notifications': 'Notifications',
                'No notifications': 'No notifications',
                'Total Complaints': 'Total Complaints',
                'Pending': 'Pending',
                'Resolved': 'Resolved',
                'Quick Stats': 'Quick Stats',
                'My Posts': 'My Posts',
                'Categories': 'Categories',
                'Road': 'Road',
                'Garbage': 'Garbage',
                'Water': 'Water',
                'Electricity': 'Electricity',
                'Load More': 'Load More'
            },
            hi: {
                'Sign in to your account': 'अपने खाते में साइन इन करें',
                'Phone/Email': 'फ़ोन/ईमेल',
                'Password': 'पासवर्ड',
                'Enter OTP': 'OTP दर्ज करें',
                'Continue': 'जारी रखें',
                'Quick Demo Login': 'त्वरित डेमो लॉगिन',
                'Sign Up': 'साइन अप करें',
                'Forgot Password?': 'पासवर्ड भूल गए?',
                'New Complaint': 'नई शिकायत',
                'Category*': 'श्रेणी*',
                'Severity': 'गंभीरता',
                'Description*': 'विवरण*',
                'Photos/Videos': 'फ़ोटो/वीडियो',
                'Location': 'स्थान',
                'Detect Location': 'स्थान का पता लगाएं',
                'Cancel': 'रद्द करें',
                'Submit Complaint': 'शिकायत दर्ज करें',
                'Complaint Details': 'शिकायत विवरण',
                'Notifications': 'सूचनाएं',
                'No notifications': 'कोई सूचना नहीं',
                'Total Complaints': 'कुल शिकायतें',
                'Pending': 'लंबित',
                'Resolved': 'हल किया गया',
                'Quick Stats': 'त्वरित आंकड़े',
                'My Posts': 'मेरी पोस्ट',
                'Categories': 'श्रेणियां',
                'Road': 'सड़क',
                'Garbage': 'कचरा',
                'Water': 'पानी',
                'Electricity': 'बिजली',
                'Load More': 'और लोड करें'
            }
        };
        
        function updateLanguage() {
            document.querySelectorAll('[data-en]').forEach(el => {
                const key = el.getAttribute('data-en');
                const translation = strings[currentLanguage]?.[key] || key;
                if (el.tagName === 'INPUT' && el.placeholder) {
                    el.placeholder = translation;
                } else {
                    el.textContent = translation;
                }
            });
            
            // Update language toggle buttons
            document.getElementById('langToggle').textContent = currentLanguage === 'en' ? 'हिंदी' : 'English';
            document.getElementById('langToggleApp').textContent = currentLanguage === 'en' ? 'HI' : 'EN';
        }
        
        // Data Seeding
        function seedData() {
            // Skip if already seeded
            if (localStorage.getItem('civic_seeded')) return;
            
            // Seed Wards
            const wards = [
                { id: 'ward_a', name: 'Ward A', code: 'WA', description: 'Central Business District', lat: 30.7333, lng: 76.7794 },
                { id: 'ward_b', name: 'Ward B', code: 'WB', description: 'Residential Area North', lat: 30.7500, lng: 76.7900 },
                { id: 'ward_c', name: 'Ward C', code: 'WC', description: 'Industrial Zone', lat: 30.7200, lng: 76.7600 },
                { id: 'ward_d', name: 'Ward D', code: 'WD', description: 'Educational Hub', lat: 30.7400, lng: 76.7700 }
            ];
            localStorage.setItem('civic_wards', JSON.stringify(wards));
            
            // Seed Departments
            const departments = [
                { id: 'dept_roads', name: 'Roads & Infrastructure', code: 'ROADS' },
                { id: 'dept_sanitation', name: 'Sanitation & Waste Management', code: 'SANITATION' },
                { id: 'dept_water', name: 'Water & Sewage', code: 'WATER' }
            ];
            localStorage.setItem('civic_departments', JSON.stringify(departments));
            
            // Seed Users
            const users = {
                'user_citizen1': {
                    id: 'user_citizen1',
                    name: 'Demo Citizen',
                    role: 'CITIZEN',
                    phone: '+911234567890',
                    wardIds: ['ward_a', 'ward_b'],
                    avatarUrl: null,
                    points: 150,
                    badges: ['Reporter', 'Community Helper']
                },
                'user_citizen2': {
                    id: 'user_citizen2',
                    name: 'Another Citizen',
                    role: 'CITIZEN',
                    phone: '+919876543210',
                    wardIds: ['ward_c', 'ward_d'],
                    avatarUrl: null,
                    points: 85,
                    badges: ['Newcomer']
                },
                'user_officer1': {
                    id: 'user_officer1',
                    name: 'Officer Smith',
                    role: 'OFFICER',
                    email: 'officer1@municipal.gov.in',
                    password: 'OfficerPass1!',
                    wardIds: ['ward_a', 'ward_b'],
                    department: 'Multiple',
                    avatarUrl: null
                },
                'user_staff1': {
                    id: 'user_staff1',
                    name: 'Staff Member',
                    role: 'DEPT_STAFF',
                    email: 'staff1@municipal.gov.in',
                    password: 'StaffPass1!',
                    wardIds: ['ward_a', 'ward_b', 'ward_c', 'ward_d'],
                    departmentId: 'dept_roads',
                    avatarUrl: null
                }
            };
            localStorage.setItem('civic_users', JSON.stringify(users));
            
            // Seed Sample Complaints with varied statuses
            const sampleComplaints = [
                {
                    id: 'complaint_1',
                    userId: 'user_citizen1',
                    wardId: 'ward_a',
                    lat: 30.7333,
                    lng: 76.7794,
                    address: 'Sector 17, Chandigarh',
                    category: 'ROAD',
                    severity: 'URGENT',
                    description: 'Large pothole causing traffic issues and potential accidents. Water logging during rains.',
                    media: [{
                        id: 'media_1',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Qb3Rob2xlIFBob3RvPC90ZXh0Pjwvc3ZnPg==',
                        type: 'image'
                    }],
                    status: 'IN_PROGRESS',
                    progressPercent: 70,
                    createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 1 * 60 * 60 * 1000).toISOString(),
                    votesCount: 12,
                    commentsCount: 5,
                    assignedTo: 'user_staff1',
                    departmentId: 'dept_roads'
                },
                {
                    id: 'complaint_2',
                    userId: 'user_citizen2',
                    wardId: 'ward_b',
                    lat: 30.7500,
                    lng: 76.7900,
                    address: 'Sector 22, Chandigarh',
                    category: 'GARBAGE',
                    severity: 'NORMAL',
                    description: 'Garbage not collected for past 3 days. Bad smell and flies around the bins.',
                    media: [{
                        id: 'media_2',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZWVlIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM3NzciIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5HYXJiYWdlIElzc3VlPC90ZXh0Pjwvc3ZnPg==',
                        type: 'image'
                    }],
                    status: 'RESOLVED',
                    progressPercent: 100,
                    createdAt: new Date(Date.now() - 5 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    votesCount: 8,
                    commentsCount: 3,
                    assignedTo: 'user_staff1',
                    departmentId: 'dept_sanitation'
                },
                {
                    id: 'complaint_3',
                    userId: 'user_citizen1',
                    wardId: 'ward_a',
                    lat: 30.7310,
                    lng: 76.7800,
                    address: 'Sector 16, Chandigarh',
                    category: 'WATER',
                    severity: 'CRITICAL',
                    description: 'No water supply since yesterday morning. Entire building affected.',
                    media: [],
                    status: 'ASSIGNED',
                    progressPercent: 40,
                    createdAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 8 * 60 * 60 * 1000).toISOString(),
                    votesCount: 25,
                    commentsCount: 12,
                    assignedTo: 'user_staff1',
                    departmentId: 'dept_water'
                },
                {
                    id: 'complaint_4',
                    userId: 'user_citizen2',
                    wardId: 'ward_c',
                    lat: 30.7200,
                    lng: 76.7600,
                    address: 'Industrial Area Phase I',
                    category: 'ELECTRICITY',
                    severity: 'URGENT',
                    description: 'Street light not working. Safety concern for pedestrians at night.',
                    media: [{
                        id: 'media_4',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjVmNWY1Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM2NjYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Ccm9rZW4gU3RyZWV0IExpZ2h0PC90ZXh0Pjwvc3ZnPg==',
                        type: 'image'
                    }],
                    status: 'TRIAGED',
                    progressPercent: 20,
                    createdAt: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString(),
                    votesCount: 6,
                    commentsCount: 2,
                    departmentId: 'dept_roads'
                },
                {
                    id: 'complaint_5',
                    userId: 'user_citizen1',
                    wardId: 'ward_b',
                    lat: 30.7480,
                    lng: 76.7850,
                    address: 'Sector 21, Chandigarh',
                    category: 'OTHER',
                    severity: 'NORMAL',
                    description: 'Illegal construction blocking the footpath. Pedestrians forced to walk on road.',
                    media: [],
                    status: 'AWAITING_VERIFICATION',
                    progressPercent: 90,
                    createdAt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 1 * 24 * 60 * 60 * 1000).toISOString(),
                    votesCount: 15,
                    commentsCount: 8,
                    assignedTo: 'user_staff1'
                },
                {
                    id: 'complaint_6',
                    userId: 'user_citizen2',
                    wardId: 'ward_d',
                    lat: 30.7400,
                    lng: 76.7700,
                    address: 'Sector 26, Chandigarh',
                    category: 'ROAD',
                    severity: 'NORMAL',
                    description: 'Traffic signal not working properly. Causing confusion and near misses.',
                    media: [{
                        id: 'media_6',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTgiIGZpbGw9IiM1NTUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5UcmFmZmljIFNpZ25hbCBJc3N1ZTwvdGV4dD48L3N2Zz4=',
                        type: 'image'
                    }],
                    status: 'SUBMITTED',
                    progressPercent: 0,
                    createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
                    updatedAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString(),
                    votesCount: 3,
                    commentsCount: 1
                }
            ];
            localStorage.setItem('civic_complaints', JSON.stringify(sampleComplaints));
            
            // Seed some complaint updates
            const sampleUpdates = [
                {
                    id: 'update_1',
                    complaintId: 'complaint_1',
                    userId: 'user_officer1',
                    status: 'TRIAGED',
                    progressPercent: 20,
                    remarks: 'Complaint triaged and categorized as urgent road maintenance.',
                    media: [],
                    createdAt: new Date(Date.now() - 36 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'update_2',
                    complaintId: 'complaint_1',
                    userId: 'user_officer1',
                    status: 'ASSIGNED',
                    progressPercent: 40,
                    remarks: 'Assigned to Roads Department. Priority: High',
                    media: [],
                    createdAt: new Date(Date.now() - 30 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'update_3',
                    complaintId: 'complaint_1',
                    userId: 'user_staff1',
                    status: 'IN_PROGRESS',
                    progressPercent: 70,
                    remarks: 'Work started. Road repair team deployed to location.',
                    media: [{
                        id: 'media_update_1',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZjhmYWZjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiM0Nzc1NjkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Xb3JrIGluIFByb2dyZXNzPC90ZXh0Pjwvc3ZnPg==',
                        type: 'image'
                    }],
                    createdAt: new Date(Date.now() - 4 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'update_4',
                    complaintId: 'complaint_2',
                    userId: 'user_staff1',
                    status: 'RESOLVED',
                    progressPercent: 100,
                    remarks: 'Garbage collection completed. Area cleaned and sanitized.',
                    media: [{
                        id: 'media_update_2',
                        url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGNmY2U3Ii8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtc2l6ZT0iMTYiIGZpbGw9IiMxNjY1MzQiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5DbGVhbmVkIEFyZWE8L3RleHQ+PC9zdmc+',
                        type: 'image'
                    }],
                    createdAt: new Date(Date.now() - 2 * 24 * 60 * 60 * 1000).toISOString()
                }
            ];
            localStorage.setItem('civic_complaint_updates', JSON.stringify(sampleUpdates));
            
            // Seed some sample comments
            const sampleComments = [
                {
                    id: 'comment_1',
                    complaintId: 'complaint_1',
                    userId: 'user_citizen2',
                    text: 'I also faced the same issue yesterday. Thanks for reporting!',
                    parentId: null,
                    createdAt: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'comment_2',
                    complaintId: 'complaint_1',
                    userId: 'user_citizen1',
                    text: 'Thank you for the support. Hope it gets fixed soon.',
                    parentId: 'comment_1',
                    createdAt: new Date(Date.now() - 8 * 60 * 60 * 1000).toISOString()
                },
                {
                    id: 'comment_3',
                    complaintId: 'complaint_3',
                    userId: 'user_citizen2',
                    text: 'Same problem in our building too. When will this be resolved?',
                    parentId: null,
                    createdAt: new Date(Date.now() - 6 * 60 * 60 * 1000).toISOString()
                }
            ];
            localStorage.setItem('civic_comments', JSON.stringify(sampleComments));
            
            // Seed some votes
            const sampleVotes = [
                { id: 'vote_1', complaintId: 'complaint_1', userId: 'user_citizen2', createdAt: new Date(Date.now() - 20 * 60 * 60 * 1000).toISOString() },
                { id: 'vote_2', complaintId: 'complaint_3', userId: 'user_citizen1', createdAt: new Date(Date.now() - 18 * 60 * 60 * 1000).toISOString() },
                { id: 'vote_3', complaintId: 'complaint_3', userId: 'user_citizen2', createdAt: new Date(Date.now() - 15 * 60 * 60 * 1000).toISOString() }
            ];
            localStorage.setItem('civic_votes', JSON.stringify(sampleVotes));
            
            localStorage.setItem('civic_seeded', 'true');
        }
        
        // UI Functions
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast show ${type}`;
            
            setTimeout(() => {
                toast.className = 'toast';
            }, duration);
            
            // Announce to screen readers
            announceToScreenReader(message);
        }
        
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('active');
            
            // Trap focus
            const focusableElements = modal.querySelectorAll('button, input, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (focusableElements.length > 0) {
                focusableElements[0].focus();
            }
        }
        
        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
        }
        
        function showLoading() {
            document.getElementById('feedSkeleton').classList.remove('hidden');
            document.getElementById('feedPosts').classList.add('hidden');
        }
        
        function hideLoading() {
            document.getElementById('feedSkeleton').classList.add('hidden');
            document.getElementById('feedPosts').classList.remove('hidden');
        }
        
        function createPostCard(complaint) {
            const userInitial = complaint.user?.name?.charAt(0).toUpperCase() || '?';
            const hasMedia = complaint.media && complaint.media.length > 0;
            
            return `
                <article class="post-card" data-complaint-id="${complaint.id}">
                    <div class="post-header">
                        <div class="post-avatar">${userInitial}</div>
                        <div class="post-meta">
                            <div class="post-author">${complaint.user?.name || 'Unknown User'}</div>
                            <div class="post-time">${formatDate(complaint.createdAt)}</div>
                        </div>
                        <div class="post-ward-badge">${getWardName(complaint.wardId)}</div>
                    </div>
                    
                    ${hasMedia ? `
                        <div class="post-media">
                            <img src="${complaint.media[0].url}" alt="Complaint media" class="post-image" loading="lazy">
                        </div>
                    ` : ''}
                    
                    <div class="post-content">
                        <div class="post-category">
                            <i class="${getCategoryIcon(complaint.category)}"></i>
                            ${complaint.category}
                            ${complaint.severity === 'URGENT' ? '<span style="color: var(--warning); margin-left: 4px;">⚡</span>' : ''}
                            ${complaint.severity === 'CRITICAL' ? '<span style="color: var(--danger); margin-left: 4px;">🚨</span>' : ''}
                        </div>
                        
                        <p class="post-description">${complaint.description}</p>
                        
                        <div class="post-location">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${complaint.address || `${complaint.lat?.toFixed(4)}, ${complaint.lng?.toFixed(4)}`}</span>
                            ${complaint.lat && complaint.lng ? `
                                <a href="https://www.google.com/maps?q=${complaint.lat},${complaint.lng}" target="_blank" rel="noopener">
                                    Open Map
                                </a>
                            ` : ''}
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-header">
                                <span class="progress-percent">${complaint.progressPercent}%</span>
                                <span class="status-chip ${getStatusClass(complaint.status)}">${getStatusText(complaint.status)}</span>
                            </div>
                            <div class="progress-bar" role="progressbar" aria-valuenow="${complaint.progressPercent}" aria-valuemin="0" aria-valuemax="100" aria-label="Complaint progress">
                                <div class="progress-fill" style="width: ${complaint.progressPercent}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="post-actions">
                        <button class="action-btn vote-btn ${isUserVoted(complaint.id) ? 'active' : ''}" data-complaint-id="${complaint.id}" title="Upvote this complaint">
                            <i class="fas fa-arrow-up"></i>
                            <span>${complaint.votesCount || 0}</span>
                        </button>
                        <button class="action-btn comment-btn" data-complaint-id="${complaint.id}" title="View comments">
                            <i class="fas fa-comment"></i>
                            <span>${complaint.commentsCount || 0}</span>
                        </button>
                        <button class="action-btn share-btn" data-complaint-id="${complaint.id}" title="Share this complaint">
                            <i class="fas fa-share"></i>
                            <span data-en="Share" data-hi="शेयर करें">Share</span>
                        </button>
                        ${currentUser?.role !== 'CITIZEN' ? `
                            <div style="margin-left: auto; display: flex; gap: 8px;">
                                ${complaint.status === 'SUBMITTED' ? `
                                    <button class="authority-btn" onclick="triageComplaint('${complaint.id}')" title="Triage complaint">
                                        Triage
                                    </button>
                                ` : ''}
                                ${complaint.status === 'TRIAGED' ? `
                                    <button class="authority-btn" onclick="assignComplaint('${complaint.id}')" title="Assign complaint">
                                        Assign
                                    </button>
                                ` : ''}
                                ${complaint.status === 'ASSIGNED' || complaint.status === 'IN_PROGRESS' ? `
                                    <button class="authority-btn secondary" onclick="updateComplaint('${complaint.id}')" title="Update status">
                                        Update
                                    </button>
                                ` : ''}
                                ${complaint.status === 'AWAITING_VERIFICATION' ? `
                                    <button class="authority-btn" onclick="resolveComplaint('${complaint.id}')" title="Mark resolved">
                                        Resolve
                                    </button>
                                ` : ''}
                                ${complaint.status !== 'RESOLVED' && complaint.status !== 'CLOSED' ? `
                                    <button class="authority-btn danger" onclick="updateComplaintStatus('${complaint.id}', 'IN_PROGRESS')" title="Mark in progress">
                                        Progress
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                </article>
            `;
        }
        
        function getWardName(wardId) {
            const wards = JSON.parse(localStorage.getItem('civic_wards') || '[]');
            const ward = wards.find(w => w.id === wardId);
            return ward?.name || 'Unknown Ward';
        }
        
        function isUserVoted(complaintId) {
            if (!currentUser) return false;
            const votes = JSON.parse(localStorage.getItem('civic_votes') || '[]');
            return votes.some(v => v.complaintId === complaintId && v.userId === currentUser.id);
        }
        
        // Authority Functions
        async function triageComplaint(id) {
            try {
                await mockServer.updateComplaint(id, {
                    status: 'TRIAGED',
                    remarks: 'Complaint has been triaged and categorized.'
                });
                showToast('Complaint triaged successfully', 'success');
                loadFeed(true);
            } catch (error) {
                showToast('Failed to triage complaint', 'error');
            }
        }
        
        async function assignComplaint(id) {
            try {
                await mockServer.updateComplaint(id, {
                    status: 'ASSIGNED',
                    assignedTo: currentUser.id,
                    remarks: 'Complaint assigned to department staff.'
                });
                showToast('Complaint assigned successfully', 'success');
                loadFeed(true);
            } catch (error) {
                showToast('Failed to assign complaint', 'error');
            }
        }
        
        async function updateComplaintStatus(id, status) {
            try {
                await mockServer.updateComplaint(id, {
                    status: status,
                    remarks: `Status updated to ${status.toLowerCase().replace('_', ' ')}.`
                });
                showToast('Complaint updated successfully', 'success');
                loadFeed(true);
            } catch (error) {
                showToast('Failed to update complaint', 'error');
            }
        }
        
        async function updateComplaint(id) {
            const remarks = prompt('Enter update remarks:');
            if (remarks) {
                try {
                    await mockServer.updateComplaint(id, {
                        status: 'IN_PROGRESS',
                        remarks: remarks
                    });
                    showToast('Complaint updated successfully', 'success');
                    loadFeed(true);
                } catch (error) {
                    showToast('Failed to update complaint', 'error');
                }
            }
        }
        
        async function resolveComplaint(id) {
            if (confirm('Are you sure you want to mark this complaint as resolved?')) {
                try {
                    await mockServer.updateComplaint(id, {
                        status: 'RESOLVED',
                        remarks: 'Complaint has been resolved and verified.'
                    });
                    showToast('Complaint resolved successfully', 'success');
                    loadFeed(true);
                } catch (error) {
                    showToast('Failed to resolve complaint', 'error');
                }
            }
        }
        
        // Feed Functions
        async function loadFeed(refresh = false) {
            if (isLoading && !refresh) return;
            isLoading = true;
            
            if (refresh) {
                feedOffset = 0;
                feedPosts = [];
                showLoading();
            }
            
            try {
                const filters = {
                    offset: feedOffset,
                    limit: feedLimit
                };
                
                // Apply role-based filtering
                if (currentUser.role === 'CITIZEN') {
                    filters.ward = currentUser.wardIds[0]; // Show posts from user's ward
                } else {
                    // Authority users see all complaints in their wards
                    const wardFilter = document.getElementById('wardFilter')?.value;
                    const statusFilter = document.getElementById('statusFilter')?.value;
                    
                    if (wardFilter) {
                        filters.ward = wardFilter;
                    }
                    if (statusFilter) {
                        if (statusFilter === 'overdue') {
                            // Implement overdue logic
                        } else {
                            filters.status = statusFilter;
                        }
                    }
                }
                
                const result = await mockServer.getComplaints(filters);
                
                if (refresh) {
                    feedPosts = result.complaints;
                } else {
                    feedPosts = [...feedPosts, ...result.complaints];
                }
                
                renderFeed();
                
                // Update load more button
                const loadMoreBtn = document.getElementById('loadMoreBtn');
                if (result.hasMore) {
                    loadMoreBtn.style.display = 'block';
                    feedOffset += feedLimit;
                } else {
                    loadMoreBtn.style.display = 'none';
                }
                
                hideLoading();
                
            } catch (error) {
                console.error('Failed to load feed:', error);
                showToast('Failed to load complaints', 'error');
                hideLoading();
            }
            
            isLoading = false;
        }
        
        function renderFeed() {
            const container = document.getElementById('feedPosts');
            const html = feedPosts.map(complaint => createPostCard(complaint)).join('');
            container.innerHTML = html;
            
            // Update language after rendering
            updateLanguage();
        }
        
        async function updateStats() {
            if (currentUser.role === 'CITIZEN') return;
            
            try {
                const allComplaints = await mockServer.getComplaints({ limit: 1000 });
                const complaints = allComplaints.complaints;
                
                const total = complaints.length;
                const pending = complaints.filter(c => ['SUBMITTED', 'TRIAGED', 'ASSIGNED', 'IN_PROGRESS'].includes(c.status)).length;
                const resolved = complaints.filter(c => ['RESOLVED', 'CLOSED'].includes(c.status)).length;
                
                document.getElementById('totalComplaints').textContent = total;
                document.getElementById('pendingComplaints').textContent = pending;
                document.getElementById('resolvedComplaints').textContent = resolved;
                
            } catch (error) {
                console.error('Failed to update stats:', error);
            }
        }
        
        // Notification Functions
        async function loadNotifications() {
            if (!currentUser) return;
            
            try {
                const notifications = await mockServer.getNotifications(currentUser.id);
                const unreadCount = notifications.filter(n => !n.read).length;
                
                // Update badge
                const badge = document.getElementById('notificationBadge');
                if (unreadCount > 0) {
                    badge.textContent = unreadCount;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }
                
                // Update dropdown
                const list = document.getElementById('notificationList');
                if (notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notification-item" style="text-align: center; color: var(--neutral-500);">
                            <span data-en="No notifications" data-hi="कोई सूचना नहीं">No notifications</span>
                        </div>
                    `;
                } else {
                    list.innerHTML = notifications.slice(0, 10).map(n => `
                        <div class="notification-item ${n.read ? '' : 'unread'}">
                            <div style="font-weight: 600; margin-bottom: 4px;">${n.title}</div>
                            <div style="color: var(--neutral-600); font-size: 0.875rem; margin-bottom: 4px;">${n.message}</div>
                            <div style="color: var(--neutral-500); font-size: 0.75rem;">${formatDate(n.createdAt)}</div>
                        </div>
                    `).join('');
                }
                
                updateLanguage();
                
            } catch (error) {
                console.error('Failed to load notifications:', error);
            }
        }
        
        // Event Handlers
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            document.getElementById('demoLogin').addEventListener('change', handleDemoLogin);
            
            // Language toggles
            document.getElementById('langToggle').addEventListener('click', toggleLanguage);
            document.getElementById('langToggleApp').addEventListener('click', toggleLanguage);
            
            // Navigation
            document.getElementById('logoutBtn').addEventListener('click', logout);
            document.getElementById('notificationBtn').addEventListener('click', toggleNotifications);
            
            // Composer
            document.getElementById('composerFab').addEventListener('click', () => showModal('composerModal'));
            document.getElementById('composerClose').addEventListener('click', () => hideModal('composerModal'));
            document.getElementById('cancelComplaint').addEventListener('click', () => hideModal('composerModal'));
            document.getElementById('complaintForm').addEventListener('submit', handleComplaintSubmit);
            
            // Media upload
            const mediaUpload = document.getElementById('mediaUpload');
            const mediaInput = document.getElementById('mediaInput');
            
            mediaUpload.addEventListener('click', () => mediaInput.click());
            mediaUpload.addEventListener('dragover', handleDragOver);
            mediaUpload.addEventListener('drop', handleDrop);
            mediaInput.addEventListener('change', handleMediaSelect);
            
            // Location detection
            document.getElementById('detectLocationBtn').addEventListener('click', detectLocation);
            
            // Detail modal
            document.getElementById('detailClose').addEventListener('click', () => hideModal('detailModal'));
            
            // Feed interactions
            document.addEventListener('click', handleFeedClick);
            
            // Load more
            document.getElementById('loadMoreBtn').addEventListener('click', () => loadFeed());
            
            // Authority filters
            const wardFilter = document.getElementById('wardFilter');
            const statusFilter = document.getElementById('statusFilter');
            if (wardFilter) wardFilter.addEventListener('change', () => loadFeed(true));
            if (statusFilter) statusFilter.addEventListener('change', () => loadFeed(true));
            
            // Modal close on backdrop
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        hideModal(overlay.id);
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    // Close any open modals
                    document.querySelectorAll('.modal-overlay.active').forEach(modal => {
                        hideModal(modal.id);
                    });
                }
            });
            
            // Offline/online detection
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
        }
        
        async function handleLogin(e) {
            e.preventDefault();
            
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('password').value;
            const otp = document.getElementById('otp').value;
            const loginBtn = document.getElementById('loginBtn');
            
            if (!loginId) {
                showError('loginIdError', 'Phone or email is required');
                return;
            }
            
            clearErrors();
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            
            try {
                // Check if it's email (authority) or phone (citizen)
                const isEmail = loginId.includes('@');
                
                if (isEmail) {
                    if (!password) {
                        showError('passwordError', 'Password is required');
                        return;
                    }
                    
                    const result = await mockServer.login({ loginId, password });
                    if (result.success) {
                        currentUser = result.user;
                        showMainApp();
                    } else {
                        showError('passwordError', result.error || 'Invalid credentials');
                    }
                } else {
                    // Phone login - two step process
                    const passwordGroup = document.getElementById('passwordGroup');
                    const otpGroup = document.getElementById('otpGroup');
                    
                    if (otpGroup.style.display === 'none') {
                        // Step 1: Request OTP
                        await mockServer.requestOTP(loginId);
                        passwordGroup.style.display = 'none';
                        otpGroup.style.display = 'block';
                        loginBtn.innerHTML = 'Verify OTP';
                        showToast('OTP sent successfully (Demo OTP: 000000)', 'success');
                    } else {
                        // Step 2: Verify OTP
                        if (!otp) {
                            showError('otpError', 'OTP is required');
                            return;
                        }
                        
                        const result = await mockServer.login({ loginId, otp });
                        if (result.success) {
                            currentUser = result.user;
                            showMainApp();
                        } else {
                            showError('otpError', result.error || 'Invalid OTP');
                        }
                    }
                }
                
            } catch (error) {
                console.error('Login error:', error);
                showToast('Login failed. Please try again.', 'error');
            } finally {
                loginBtn.disabled = false;
                if (loginBtn.innerHTML.includes('Signing in')) {
                    loginBtn.innerHTML = '<span data-en="Continue" data-hi="जारी रखें">Continue</span>';
                }
            }
        }
        
        function handleDemoLogin(e) {
            const value = e.target.value;
            if (!value) return;
            
            const loginId = document.getElementById('loginId');
            const password = document.getElementById('password');
            const passwordGroup = document.getElementById('passwordGroup');
            const otpGroup = document.getElementById('otpGroup');
            
            switch (value) {
                case 'citizen1':
                    loginId.value = '+911234567890';
                    passwordGroup.style.display = 'none';
                    otpGroup.style.display = 'none';
                    break;
                case 'citizen2':
                    loginId.value = '+919876543210';
                    passwordGroup.style.display = 'none';
                    otpGroup.style.display = 'none';
                    break;
                case 'officer':
                    loginId.value = 'officer1@municipal.gov.in';
                    password.value = 'OfficerPass1!';
                    passwordGroup.style.display = 'block';
                    otpGroup.style.display = 'none';
                    break;
                case 'staff':
                    loginId.value = 'staff1@municipal.gov.in';
                    password.value = 'StaffPass1!';
                    passwordGroup.style.display = 'block';
                    otpGroup.style.display = 'none';
                    break;
            }
        }
        
        function showError(fieldId, message) {
            const errorElement = document.getElementById(fieldId);
            if (errorElement) {
                errorElement.textContent = message;
                const inputElement = errorElement.previousElementSibling;
                if (inputElement && inputElement.classList.contains('input')) {
                    inputElement.classList.add('error');
                }
            }
        }
        
        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
            document.querySelectorAll('.input.error').forEach(el => el.classList.remove('error'));
        }
        
        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user info
            const userAvatar = document.getElementById('userAvatar');
            const userName = document.getElementById('userName');
            const userRole = document.getElementById('userRole');
            
            userAvatar.textContent = currentUser.name.charAt(0).toUpperCase();
            userName.textContent = currentUser.name;
            userRole.textContent = currentUser.role === 'CITIZEN' ? 'Citizen' : 
                                 currentUser.role === 'OFFICER' ? 'Officer' : 'Staff';
            
            // Show authority interface for non-citizens
            if (currentUser.role !== 'CITIZEN') {
                document.getElementById('authorityHeader').classList.remove('hidden');
                populateWardFilter();
            }
            
            // Load initial data
            loadFeed(true);
            loadNotifications();
            updateStats();
        }
        
        function populateWardFilter() {
            const wards = JSON.parse(localStorage.getItem('civic_wards') || '[]');
            const wardFilter = document.getElementById('wardFilter');
            
            wardFilter.innerHTML = '<option value="">All Wards</option>';
            wards.forEach(ward => {
                if (currentUser.wardIds.includes(ward.id)) {
                    wardFilter.innerHTML += `<option value="${ward.id}">${ward.name}</option>`;
                }
            });
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                feedPosts = [];
                feedOffset = 0;
                
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                document.getElementById('authorityHeader').classList.add('hidden');
                
                // Reset login form
                document.getElementById('loginForm').reset();
                document.getElementById('passwordGroup').style.display = 'none';
                document.getElementById('otpGroup').style.display = 'none';
                clearErrors();
            }
        }
        
        function toggleLanguage() {
            currentLanguage = currentLanguage === 'en' ? 'hi' : 'en';
            updateLanguage();
            localStorage.setItem('civic_language', currentLanguage);
        }
        
        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('active');
        }
        
        async function handleComplaintSubmit(e) {
            e.preventDefault();
            
            const category = document.getElementById('complaintCategory').value;
            const severity = document.getElementById('complaintSeverity').value;
            const description = document.getElementById('complaintDescription').value;
            const lat = parseFloat(document.getElementById('complaintLat').value);
            const lng = parseFloat(document.getElementById('complaintLng').value);
            
            // Validation
            if (!category) {
                showError('categoryError', 'Category is required');
                return;
            }
            if (description.length < 10) {
                showError('descriptionError', 'Description must be at least 10 characters');
                return;
            }
            if (!lat || !lng) {
                showError('locationError', 'Location is required');
                return;
            }
            
            clearErrors();
            
            const submitBtn = document.getElementById('submitComplaint');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                // Get media files
                const mediaFiles = Array.from(document.getElementById('mediaPreview').children).map((item, index) => ({
                    id: `media_${Date.now()}_${index}`,
                    url: item.querySelector('img').src,
                    type: 'image'
                }));
                
                const complaint = {
                    userId: currentUser.id,
                    wardId: currentUser.wardIds[0], // Use user's primary ward
                    category,
                    severity,
                    description,
                    lat,
                    lng,
                    address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`, // Use coordinates as address
                    media: mediaFiles
                };
                
                const result = await mockServer.createComplaint(complaint);
                
                if (result.success) {
                    hideModal('composerModal');
                    document.getElementById('complaintForm').reset();
                    document.getElementById('mediaPreview').innerHTML = '';
                    showToast(`Complaint submitted successfully! ID: ${result.complaint.id}`, 'success');
                    loadFeed(true);
                    announceToScreenReader('New complaint created and added to feed');
                } else {
                    showToast(result.error || 'Failed to submit complaint', 'error');
                }
                
            } catch (error) {
                console.error('Submit error:', error);
                showToast('Failed to submit complaint. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<span data-en="Submit Complaint" data-hi="शिकायत दर्ज करें">Submit Complaint</span>';
                updateLanguage();
            }
        }
        
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }
        
        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processMediaFiles(files);
        }
        
        function handleMediaSelect(e) {
            const files = e.target.files;
            processMediaFiles(files);
        }
        
        function processMediaFiles(files) {
            const preview = document.getElementById('mediaPreview');
            const maxFiles = 5;
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            if (preview.children.length + files.length > maxFiles) {
                showError('mediaError', `Maximum ${maxFiles} files allowed`);
                return;
            }
            
            Array.from(files).forEach((file, index) => {
                if (file.size > maxSize) {
                    showError('mediaError', `File ${file.name} is too large (max 5MB)`);
                    return;
                }
                
                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                    showError('mediaError', `File ${file.name} is not a valid image or video`);
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const mediaItem = document.createElement('div');
                    mediaItem.className = 'media-item';
                    mediaItem.innerHTML = `
                        <img src="${e.target.result}" alt="Upload preview">
                        <button type="button" class="media-remove" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    preview.appendChild(mediaItem);
                };
                reader.readAsDataURL(file);
            });
        }
        
        async function detectLocation() {
            const statusEl = document.getElementById('locationStatus');
            const btn = document.getElementById('detectLocationBtn');
            const latInput = document.getElementById('complaintLat');
            const lngInput = document.getElementById('complaintLng');
            
            if (!navigator.geolocation) {
                showError('locationError', 'Geolocation is not supported by this browser');
                return;
            }
            
            btn.disabled = true;
            statusEl.textContent = 'Detecting location...';
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    latInput.value = position.coords.latitude.toFixed(6);
                    lngInput.value = position.coords.longitude.toFixed(6);
                    statusEl.textContent = 'Location detected successfully';
                    statusEl.style.color = 'var(--success)';
                    btn.disabled = false;
                },
                (error) => {
                    let message = 'Failed to detect location';
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message = 'Location access denied. Please enable location and try again.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = 'Location information unavailable';
                            break;
                        case error.TIMEOUT:
                            message = 'Location request timed out';
                            break;
                    }
                    statusEl.textContent = message;
                    statusEl.style.color = 'var(--danger)';
                    showError('locationError', 'Please enter coordinates manually');
                    btn.disabled = false;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 300000
                }
            );
        }
        
        async function handleFeedClick(e) {
            const complaintCard = e.target.closest('.post-card');
            if (!complaintCard) return;
            
            const complaintId = complaintCard.dataset.complaintId;
            
            if (e.target.closest('.vote-btn')) {
                await handleVote(complaintId);
            } else if (e.target.closest('.comment-btn')) {
                await showComplaintDetail(complaintId);
            } else if (e.target.closest('.share-btn')) {
                await handleShare(complaintId);
            } else if (e.target.closest('.post-card') && !e.target.closest('.post-actions')) {
                await showComplaintDetail(complaintId);
            }
        }
        
        async function handleVote(complaintId) {
            if (!currentUser) return;
            
            try {
                const result = await mockServer.toggleVote(complaintId);
                if (result.success) {
                    // Update UI immediately
                    const voteBtn = document.querySelector(`[data-complaint-id="${complaintId}"].vote-btn`);
                    if (voteBtn) {
                        const countSpan = voteBtn.querySelector('span');
                        const currentCount = parseInt(countSpan.textContent) || 0;
                        
                        if (result.voted) {
                            voteBtn.classList.add('active');
                            countSpan.textContent = currentCount + 1;
                            announceToScreenReader('Vote added');
                        } else {
                            voteBtn.classList.remove('active');
                            countSpan.textContent = Math.max(0, currentCount - 1);
                            announceToScreenReader('Vote removed');
                        }
                    }
                }
            } catch (error) {
                console.error('Vote error:', error);
                showToast('Failed to vote', 'error');
            }
        }
        
        async function handleShare(complaintId) {
            const complaint = feedPosts.find(c => c.id === complaintId);
            if (!complaint) return;
            
            const shareData = {
                title: `Civic Complaint - ${complaint.category}`,
                text: complaint.description,
                url: `${window.location.origin}?complaint=${complaintId}`
            };
            
            try {
                if (navigator.share && navigator.canShare && navigator.canShare(shareData)) {
                    await navigator.share(shareData);
                } else {
                    // Fallback to clipboard
                    await navigator.clipboard.writeText(`${shareData.title}\n${shareData.text}\n${shareData.url}`);
                    showToast('Link copied to clipboard', 'success');
                }
            } catch (error) {
                console.error('Share error:', error);
                showToast('Failed to share', 'error');
            }
        }
        
        async function showComplaintDetail(complaintId) {
            const complaint = feedPosts.find(c => c.id === complaintId);
            if (!complaint) return;
            
            try {
                // Get additional data
                const [updatesResult, commentsResult] = await Promise.all([
                    mockServer.getComplaintUpdates(complaintId),
                    mockServer.getComments(complaintId)
                ]);
                
                const updates = updatesResult.updates || [];
                const comments = commentsResult.comments || [];
                
                // Build detail content
                const detailContent = document.getElementById('detailContent');
                detailContent.innerHTML = `
                    <div style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                            <div class="post-avatar">${complaint.user?.name?.charAt(0).toUpperCase() || '?'}</div>
                            <div>
                                <div style="font-weight: 600;">${complaint.user?.name || 'Unknown User'}</div>
                                <div style="color: var(--neutral-500); font-size: 0.875rem;">${formatDate(complaint.createdAt)}</div>
                            </div>
                            <div class="post-ward-badge">${getWardName(complaint.wardId)}</div>
                        </div>
                        
                        ${complaint.media && complaint.media.length > 0 ? `
                            <div style="margin-bottom: 16px;">
                                <img src="${complaint.media[0].url}" alt="Complaint media" style="width: 100%; border-radius: 8px;">
                            </div>
                        ` : ''}
                        
                        <div class="post-category" style="margin-bottom: 12px;">
                            <i class="${getCategoryIcon(complaint.category)}"></i>
                            ${complaint.category}
                            ${complaint.severity === 'URGENT' ? '<span style="color: var(--warning); margin-left: 4px;">⚡</span>' : ''}
                            ${complaint.severity === 'CRITICAL' ? '<span style="color: var(--danger); margin-left: 4px;">🚨</span>' : ''}
                        </div>
                        
                        <p style="margin-bottom: 16px; line-height: 1.6;">${complaint.description}</p>
                        
                        <div style="display: flex; align-items: center; gap: 8px; color: var(--neutral-500); font-size: 0.875rem; margin-bottom: 16px;">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${complaint.address || `${complaint.lat?.toFixed(4)}, ${complaint.lng?.toFixed(4)}`}</span>
                            ${complaint.lat && complaint.lng ? `
                                <a href="https://www.google.com/maps?q=${complaint.lat},${complaint.lng}" target="_blank" rel="noopener" style="color: var(--primary);">
                                    Open Map
                                </a>
                            ` : ''}
                        </div>
                        
                        <div class="progress-container">
                            <div class="progress-header">
                                <span class="progress-percent">${complaint.progressPercent}%</span>
                                <span class="status-chip ${getStatusClass(complaint.status)}">${getStatusText(complaint.status)}</span>
                            </div>
                            <div class="progress-bar" role="progressbar" aria-valuenow="${complaint.progressPercent}" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-fill" style="width: ${complaint.progressPercent}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    ${updates.length > 0 ? `
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin-bottom: 16px; font-weight: 600;" data-en="Timeline" data-hi="समयरेखा">Timeline</h3>
                            <div style="position: relative; padding-left: 24px;">
                                <div style="position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--neutral-200);"></div>
                                ${updates.map(update => `
                                    <div style="position: relative; margin-bottom: 16px; background: var(--neutral-50); padding: 12px; border-radius: 8px;">
                                        <div style="position: absolute; left: -20px; top: 12px; width: 8px; height: 8px; background: var(--primary); border-radius: 50%;"></div>
                                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                                            <div>
                                                <div style="font-weight: 600; font-size: 0.875rem;">${update.user?.name || 'System'}</div>
                                                <div style="color: var(--neutral-500); font-size: 0.75rem;">${formatDate(update.createdAt)}</div>
                                            </div>
                                            <span class="status-chip ${getStatusClass(update.status)}">${getStatusText(update.status)}</span>
                                        </div>
                                        ${update.remarks ? `<p style="color: var(--neutral-700); font-size: 0.875rem;">${update.remarks}</p>` : ''}
                                        ${update.media && update.media.length > 0 ? `
                                            <img src="${update.media[0].url}" alt="Update media" style="width: 100%; max-width: 200px; border-radius: 4px; margin-top: 8px;">
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div>
                        <h3 style="margin-bottom: 16px; font-weight: 600;" data-en="Comments" data-hi="टिप्पणियाँ">Comments (${comments.length})</h3>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="display: flex; gap: 12px;">
                                <div class="post-avatar" style="width: 32px; height: 32px; font-size: 0.875rem;">${currentUser?.name?.charAt(0).toUpperCase() || 'U'}</div>
                                <div style="flex: 1;">
                                    <input type="text" id="newCommentInput" class="input" placeholder="Add a comment..." style="font-size: 0.875rem;">
                                    <button type="button" id="addCommentBtn" class="btn btn-primary" style="margin-top: 8px; font-size: 0.875rem; padding: 6px 12px;" data-complaint-id="${complaintId}">
                                        <span data-en="Post Comment" data-hi="टिप्पणी पोस्ट करें">Post Comment</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="commentsList">
                            ${comments.length > 0 ? comments.map(comment => `
                                <div style="display: flex; gap: 12px; margin-bottom: 16px; ${comment.parentId ? 'margin-left: 32px;' : ''}">
                                    <div class="post-avatar" style="width: 32px; height: 32px; font-size: 0.875rem;">${comment.user?.name?.charAt(0).toUpperCase() || 'U'}</div>
                                    <div style="flex: 1;">
                                        <div style="background: var(--neutral-100); padding: 8px 12px; border-radius: 8px;">
                                            <div style="font-weight: 600; font-size: 0.875rem; margin-bottom: 2px;">${comment.user?.name || 'Unknown User'}</div>
                                            <p style="font-size: 0.875rem; color: var(--neutral-700);">${comment.text}</p>
                                        </div>
                                        <div style="color: var(--neutral-500); font-size: 0.75rem; margin-top: 4px; padding-left: 12px;">${formatDate(comment.createdAt)}</div>
                                    </div>
                                </div>
                            `).join('') : `
                                <p style="text-align: center; color: var(--neutral-500); font-style: italic;" data-en="No comments yet" data-hi="अभी तक कोई टिप्पणी नहीं">No comments yet</p>
                            `}
                        </div>
                    </div>
                    
                    ${complaint.userId === currentUser?.id && complaint.status === 'AWAITING_VERIFICATION' ? `
                        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--neutral-200);">
                            <button class="btn btn-success" onclick="confirmResolution('${complaintId}')" style="width: 100%;">
                                <i class="fas fa-check"></i>
                                <span data-en="Confirm Resolution" data-hi="समाधान की पुष्टि करें">Confirm Resolution</span>
                            </button>
                        </div>
                    ` : ''}
                `;
                
                // Add comment functionality
                const addCommentBtn = detailContent.querySelector('#addCommentBtn');
                const commentInput = detailContent.querySelector('#newCommentInput');
                
                addCommentBtn.addEventListener('click', async () => {
                    const text = commentInput.value.trim();
                    if (!text) return;
                    
                    try {
                        addCommentBtn.disabled = true;
                        const result = await mockServer.addComment(complaintId, { text });
                        
                        if (result.success) {
                            commentInput.value = '';
                            showToast('Comment added successfully', 'success');
                            // Refresh the modal content
                            showComplaintDetail(complaintId);
                        }
                    } catch (error) {
                        showToast('Failed to add comment', 'error');
                    } finally {
                        addCommentBtn.disabled = false;
                    }
                });
                
                // Enter key to submit comment
                commentInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        addCommentBtn.click();
                    }
                });
                
                showModal('detailModal');
                updateLanguage();
                
            } catch (error) {
                console.error('Detail error:', error);
                showToast('Failed to load complaint details', 'error');
            }
        }
        
        async function confirmResolution(complaintId) {
            if (confirm('Are you sure this complaint has been resolved to your satisfaction?')) {
                try {
                    await mockServer.updateComplaint(complaintId, {
                        status: 'RESOLVED',
                        remarks: 'Confirmed as resolved by complaint owner.'
                    });
                    showToast('Thank you! Complaint marked as resolved.', 'success');
                    hideModal('detailModal');
                    loadFeed(true);
                } catch (error) {
                    showToast('Failed to confirm resolution', 'error');
                }
            }
        }
        
        function handleOnline() {
            document.getElementById('offlineBanner').classList.add('hidden');
            syncPendingComplaints();
        }
        
        function handleOffline() {
            document.getElementById('offlineBanner').classList.remove('hidden');
        }
        
        async function syncPendingComplaints() {
            const pendingQueue = JSON.parse(localStorage.getItem('civic_pending_queue') || '[]');
            if (pendingQueue.length === 0) return;
            
            showToast(`Syncing ${pendingQueue.length} pending complaints...`, 'info');
            
            for (const complaint of pendingQueue) {
                try {
                    await mockServer.createComplaint(complaint);
                } catch (error) {
                    console.error('Failed to sync complaint:', error);
                }
            }
            
            localStorage.removeItem('civic_pending_queue');
            showToast('All complaints synced successfully', 'success');
            loadFeed(true);
        }
        
        // Initialize Application
        function initApp() {
            // Check if already seeded
            seedData();
            
            // Load saved language preference
            const savedLang = localStorage.getItem('civic_language');
            if (savedLang) {
                currentLanguage = savedLang;
            }
            updateLanguage();
            
            // Setup event listeners
            setupEventListeners();
            
            // Check for offline status
            if (!navigator.onLine) {
                handleOffline();
            }
            
            // Request notification permission
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Check for demo parameter in URL
            const urlParams = new URLSearchParams(window.location.search);
            const demoStep = urlParams.get('demo');
            if (demoStep) {
                // Auto-run demo steps
                runDemoScript(demoStep);
            }
        }
        
        function runDemoScript(step) {
            // Implementation for automated demo script
            console.log('Running demo step:', step);
        }
        
        // Run sanity checks for testing
        function runSanityChecks() {
            const checks = [
                () => document.getElementById('loginScreen') !== null,
                () => document.getElementById('mainApp') !== null,
                () => localStorage.getItem('civic_seeded') === 'true',
                () => JSON.parse(localStorage.getItem('civic_complaints') || '[]').length > 0,
                () => JSON.parse(localStorage.getItem('civic_users') || '{}')['user_citizen1'] !== undefined,
                () => typeof mockServer.createComplaint === 'function',
                () => typeof showToast === 'function',
                () => typeof broadcastUpdate === 'function'
            ];
            
            const results = checks.map((check, index) => {
                try {
                    const result = check();
                    console.log(`✓ Check ${index + 1}: PASS`);
                    return result;
                } catch (error) {
                    console.error(`✗ Check ${index + 1}: FAIL`, error);
                    return false;
                }
            });
            
            const passCount = results.filter(Boolean).length;
            console.log(`Sanity Checks: ${passCount}/${checks.length} passed`);
            
            return passCount === checks.length;
        }
        
        // Start the application
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
            
            // Run sanity checks in development
            if (window.location.search.includes('debug=true')) {
                setTimeout(runSanityChecks, 1000);
            }
        });
        
        // Global functions for authority actions (called from HTML)
        window.triageComplaint = triageComplaint;
        window.assignComplaint = assignComplaint;
        window.updateComplaint = updateComplaint;
        window.resolveComplaint = resolveComplaint;
        window.updateComplaintStatus = updateComplaintStatus;
        window.confirmResolution = confirmResolution;
        window.runSanityChecks = runSanityChecks;
        
        // =============================================================================
        // INTEGRATION EXAMPLES FOR REAL BACKEND
        // =============================================================================
        
        /*
        EXAMPLE API INTEGRATION:
        
        // Replace mockServer.login with:
        async function loginAPI(credentials) {
            const response = await fetch('/api/auth/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(credentials)
            });
            return response.json();
        }
        
        // Replace mockServer.createComplaint with:
        async function createComplaintAPI(complaint) {
            const token = localStorage.getItem('auth_token');
            const response = await fetch('/api/complaints', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(complaint)
            });
            return response.json();
        }
        
        // OTP Request/Verify:
        POST /api/auth/otp/request
        { "phone": "+911234567890" }
        
        POST /api/auth/otp/verify  
        { "phone": "+911234567890", "otp": "123456" }
        
        // Complaint Operations:
        GET /api/complaints?ward=ward_a&status=SUBMITTED&offset=0&limit=10
        POST /api/complaints { complaint_data }
        PUT /api/complaints/:id { update_data }
        
        // Real-time Updates (WebSocket):
        const ws = new WebSocket('wss://api.example.com/complaints/updates');
        ws.onmessage = (event) => {
            const update = JSON.parse(event.data);
            broadcastUpdate(update.type, update.data);
        };
        */
    </script>
</body>
</html>

<!--
=============================================================================
DEMO CHECKLIST
=============================================================================

1. ✓ Open index.html in browser
2. ✓ Verify clean login page (no operational metrics shown)
3. ✓ Use "Demo Login" dropdown → Select "Citizen 1" → Login successfully
4. ✓ Confirm landing on Instagram-style feed with progress bars
5. ✓ Click floating "+" button → Open complaint composer
6. ✓ Fill complaint form → Upload image → Detect location → Submit
7. ✓ Verify new complaint appears in feed with 0% progress
8. ✓ Open new tab → Login as "Officer" → See authority dashboard
9. ✓ Find new complaint → Click "Triage" → Verify progress updates to 20%
10. ✓ Click "Assign" → Progress updates to 40% → Switch to citizen tab
11. ✓ Verify real-time update in citizen tab (progress bar + notification)
12. ✓ Officer: Add update with remarks → Mark "In Progress" → 70% progress
13. ✓ Officer: Mark as resolved → 100% progress + notification to citizen
14. ✓ Test offline mode → Create complaint → Verify queuing
15. ✓ Test online sync → Verify queued complaints sync automatically

ACCESSIBILITY TESTS:
- Tab navigation works on all interactive elements
- Screen reader announcements work for dynamic content
- Progress bars have proper ARIA attributes
- All buttons have focus states
- Color contrast meets WCAG guidelines

CROSS-TAB TESTS:
- Updates in one tab reflect in other tabs
- Real-time notifications work across tabs
- Vote/comment changes broadcast correctly

INTEGRATION READY:
- All mock functions documented with real API examples
- localStorage can be swapped for real backend calls
- Authentication flow ready for JWT integration
- WebSocket integration examples provided
-->
